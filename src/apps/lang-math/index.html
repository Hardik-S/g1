<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LangMath Calculator</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "SF Pro Display", "Segoe UI", sans-serif;
        background: #f2f4ff;
        min-height: 100%;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.25rem;
        background: radial-gradient(circle at top, #f9f9ff 0%, #eef1ff 65%, #e6ebff 100%);
        color: #1f2146;
      }

      .langmath-app {
        width: min(920px, 100%);
        display: flex;
        align-items: stretch;
        justify-content: center;
        gap: 1.5rem;
        position: relative;
      }

      main {
        flex: 1 1 520px;
        width: 100%;
        max-width: 520px;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 20px;
        padding: 2.5rem 2rem;
        box-shadow: 0 34px 55px -45px rgba(56, 49, 235, 0.65), 0 18px 45px -35px rgba(15, 16, 60, 0.55);
        backdrop-filter: blur(6px);
      }

      h1 {
        margin: 0;
        font-size: clamp(1.75rem, 5vw, 2.3rem);
        letter-spacing: -0.01em;
      }

      p {
        margin: 0;
        line-height: 1.6;
        color: #5b5e7c;
      }

      .input-label {
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a7fb1;
      }

      .input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      input[type="text"] {
        flex: 1 1 auto;
        padding: 0.9rem 1.05rem;
        border-radius: 14px;
        border: 1px solid rgba(119, 126, 173, 0.35);
        background: rgba(248, 249, 255, 0.9);
        font-size: 1.05rem;
        color: #22244c;
        transition: border-color 150ms ease, box-shadow 150ms ease, transform 150ms ease;
      }

      input[type="text"]::placeholder {
        color: rgba(121, 124, 160, 0.68);
      }

      input[type="text"]:focus {
        outline: none;
        border-color: rgba(104, 93, 241, 0.9);
        box-shadow: 0 18px 38px -30px rgba(104, 93, 241, 0.8), 0 0 0 3px rgba(104, 93, 241, 0.18);
        transform: translateY(-1px);
      }

      button {
        flex: 0 0 auto;
        border: none;
        border-radius: 14px;
        padding: 0.92rem 1.55rem;
        background: linear-gradient(135deg, #6c5ce7, #7f6bff);
        color: white;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease, opacity 150ms ease;
        box-shadow: 0 24px 35px -28px rgba(108, 92, 231, 0.95);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
        box-shadow: none;
        transform: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1.5px);
        box-shadow: 0 28px 42px -30px rgba(96, 84, 225, 0.95);
      }

      button:not(:disabled):active {
        transform: translateY(0);
      }

      .result-box {
        border-radius: 14px;
        padding: 1rem 1.15rem;
        min-height: 3.25rem;
        display: flex;
        align-items: center;
        background: rgba(243, 245, 255, 0.85);
        border: 1px solid rgba(123, 130, 200, 0.25);
        color: #31345f;
        font-size: 1.05rem;
        transition: background 200ms ease, color 200ms ease, border-color 200ms ease;
      }

      .result-box[data-state="loading"] {
        font-style: italic;
        color: #676b94;
      }

      .result-box[data-state="error"] {
        background: rgba(255, 235, 238, 0.9);
        border-color: rgba(220, 85, 98, 0.4);
        color: #c2404d;
      }

      .result-box[data-state="result"] {
        background: rgba(224, 255, 243, 0.92);
        border-color: rgba(74, 201, 134, 0.45);
        color: #1f7d52;
        font-weight: 600;
      }

      .result-box[data-state="info"] {
        background: rgba(237, 239, 255, 0.88);
        border-color: rgba(131, 137, 211, 0.35);
      }

      .result-box.pulse {
        animation: resultPulse 650ms ease;
      }

      .steps-container {
        border-radius: 14px;
        background: rgba(237, 239, 255, 0.88);
        border: 1px solid rgba(131, 137, 211, 0.35);
        padding: 1.25rem 1.15rem 1.35rem;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        color: #1f2146;
      }

      .steps-title {
        margin: 0;
        font-size: 0.95rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-weight: 700;
        color: #575d99;
      }

      .steps-list {
        margin: 0;
        padding-left: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        color: #31345f;
        font-size: 0.98rem;
      }

      .steps-list li {
        line-height: 1.5;
      }

      .history-panel {
        flex: 0 0 260px;
        width: 260px;
        background: rgba(249, 249, 255, 0.85);
        border-radius: 20px;
        padding: 1.75rem 1.5rem;
        box-shadow: 0 32px 46px -44px rgba(42, 40, 120, 0.66);
        border: 1px solid rgba(149, 152, 218, 0.28);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: opacity 200ms ease, transform 200ms ease, flex-basis 200ms ease, width 200ms ease;
      }

      .history-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .history-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
        color: #373a6a;
      }

      .history-toggle {
        border: none;
        background: rgba(124, 132, 215, 0.18);
        color: #565c8f;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.4rem 0.75rem;
        border-radius: 10px;
        cursor: pointer;
        transition: background 150ms ease, color 150ms ease;
      }

      .history-toggle:hover,
      .history-toggle:focus-visible {
        background: rgba(108, 92, 231, 0.2);
        color: #3d3f6b;
        outline: none;
      }

      .history-toggle-tab {
        position: absolute;
        top: 1rem;
        right: 0;
        transform: translateX(calc(100% + 0.75rem));
        display: none;
        box-shadow: 0 18px 32px -24px rgba(96, 84, 225, 0.9);
        z-index: 2;
      }

      .langmath-app[data-history='collapsed'] .history-toggle-tab {
        display: inline-flex;
      }

      .history-empty {
        margin: 0;
        font-size: 0.9rem;
        color: #6a6fa0;
      }

      .history-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        overflow-y: auto;
        max-height: 360px;
      }

      .history-entry {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding-bottom: 0.55rem;
        border-bottom: 1px solid rgba(156, 160, 220, 0.25);
      }

      .history-entry:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .history-query {
        font-size: 0.95rem;
        color: #2f3162;
      }

      .history-result {
        font-size: 0.88rem;
        color: #565c8f;
      }

      .langmath-app[data-history='collapsed'] {
        justify-content: center;
      }

      .langmath-app[data-history='collapsed'] .history-panel {
        flex-basis: 0;
        width: 0;
        opacity: 0;
        transform: translateX(16px);
        pointer-events: none;
      }

      @keyframes resultPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.18);
        }
        100% {
          box-shadow: 0 0 0 28px rgba(108, 92, 231, 0);
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 2rem 1rem;
        }

        .input-row {
          flex-direction: column;
          align-items: stretch;
        }

        button {
          width: 100%;
        }

        .langmath-app {
          flex-direction: column;
          align-items: stretch;
          gap: 1.25rem;
        }

        .history-panel {
          width: 100%;
          flex-basis: auto;
          opacity: 1;
          transform: none;
          pointer-events: auto;
        }

        .langmath-app[data-history='collapsed'] .history-panel {
          display: none;
        }

        .history-toggle-tab {
          position: static;
          transform: none;
          align-self: flex-end;
          display: none;
          margin-top: -0.5rem;
        }

        .langmath-app[data-history='collapsed'] .history-toggle-tab {
          display: inline-flex;
        }

        main {
          padding: 2rem 1.5rem;
          max-width: none;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 1ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0ms !important;
          scroll-behavior: auto !important;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  </head>
  <body>
    <div class="langmath-app" id="langmath-shell" data-history="open">
      <main>
        <header>
          <h1>LangMath</h1>
          <p>Speak your arithmetic. Try phrases like “twenty one times four” or “ninety nine minus eight”.</p>
        </header>

        <label class="input-label" for="langmath-query">Math prompt</label>
        <div class="input-row">
          <input
            id="langmath-query"
            type="text"
            inputmode="text"
            autocomplete="off"
            spellcheck="false"
            placeholder="e.g. sixty three divided by nine"
            aria-describedby="langmath-result"
          />
          <button id="langmath-button" type="button">Calculate</button>
        </div>

        <div class="result-box" id="langmath-result" role="status" aria-live="polite" data-state="loading">
          <span id="langmath-result-text">Loading Python runtime…</span>
        </div>

        <section class="steps-container" id="langmath-steps" hidden>
          <h2 class="steps-title">How we solved it</h2>
          <ol class="steps-list" id="langmath-steps-list"></ol>
        </section>
      </main>

      <aside class="history-panel" id="langmath-history" aria-hidden="false">
        <header class="history-header">
          <h2 class="history-title">History</h2>
          <button
            type="button"
            class="history-toggle"
            data-history-toggle
            aria-expanded="true"
            aria-controls="langmath-history-list"
          >
            Hide history
          </button>
        </header>
        <p class="history-empty" id="langmath-history-empty">No calculations yet.</p>
        <ol class="history-list" id="langmath-history-list"></ol>
      </aside>
      <button
        type="button"
        class="history-toggle history-toggle-tab"
        data-history-toggle
        aria-expanded="true"
        aria-controls="langmath-history-list"
      >
        Show history
      </button>
    </div>

    <script>
      (function () {
        const input = document.getElementById('langmath-query');
        const button = document.getElementById('langmath-button');
        const resultBox = document.getElementById('langmath-result');
        const resultText = document.getElementById('langmath-result-text');
        const shell = document.getElementById('langmath-shell');
        const stepsSection = document.getElementById('langmath-steps');
        const stepsList = document.getElementById('langmath-steps-list');
        const historyPanel = document.getElementById('langmath-history');
        const historyList = document.getElementById('langmath-history-list');
        const historyEmpty = document.getElementById('langmath-history-empty');
        const historyToggleButtons = document.querySelectorAll('[data-history-toggle]');

        const operatorMap = {
          plus: '+',
          minus: '-',
          times: '*',
          multiplied_by: '*',
          divided_by: '/',
        };

        const skipTokens = new Set([
          'and',
          'of',
          'the',
          'what',
          'is',
          'please',
          'calculate',
          'compute',
          'value',
          'for',
          'a',
          'an',
        ]);

        const constantsMap = {
          pi: 'pi',
          tau: 'tau',
        };

        const functionNameMap = {
          sqrt: 'sqrt',
          exp: 'exp',
          log10: 'log10',
          log2: 'log2',
          ln: 'log',
          sin: 'sin',
          cos: 'cos',
          tan: 'tan',
          factorial: 'factorial',
        };

        const allowedIdentifiers = new Set([
          ...Object.values(functionNameMap),
          ...Object.values(constantsMap),
        ]);

        const onesMap = {
          zero: 0,
          one: 1,
          two: 2,
          three: 3,
          four: 4,
          five: 5,
          six: 6,
          seven: 7,
          eight: 8,
          nine: 9,
          ten: 10,
          eleven: 11,
          twelve: 12,
          thirteen: 13,
          fourteen: 14,
          fifteen: 15,
          sixteen: 16,
          seventeen: 17,
          eighteen: 18,
          nineteen: 19,
        };

        const tensMap = {
          twenty: 20,
          thirty: 30,
          forty: 40,
          fifty: 50,
          sixty: 60,
          seventy: 70,
          eighty: 80,
          ninety: 90,
        };

        const historyEntries = [];

        const pyodideReady = loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });

        let runtimeReady = false;

        const formatTokenDisplay = (token) => `"${token.replace(/_/g, ' ')}"`;
        const formatConvertedDisplay = (token) => `"${token}"`;

        const clearSteps = () => {
          stepsList.innerHTML = '';
          stepsSection.hidden = true;
        };

        const renderSteps = (steps) => {
          if (!steps || !steps.length) {
            clearSteps();
            return;
          }

          stepsList.innerHTML = '';
          steps.forEach((step) => {
            const item = document.createElement('li');
            item.textContent = step;
            stepsList.appendChild(item);
          });
          stepsSection.hidden = false;
        };

        const updateHistoryToggleState = (expanded) => {
          historyToggleButtons.forEach((button) => {
            button.setAttribute('aria-expanded', expanded.toString());
            button.textContent = expanded ? 'Hide history' : 'Show history';
          });
        };

        const renderHistory = () => {
          if (!historyEntries.length) {
            historyEmpty.hidden = false;
            historyList.innerHTML = '';
            historyList.hidden = true;
            return;
          }

          historyEmpty.hidden = true;
          historyList.hidden = false;
          historyList.innerHTML = '';

          for (let index = historyEntries.length - 1; index >= 0; index -= 1) {
            const entry = historyEntries[index];
            const listItem = document.createElement('li');
            listItem.className = 'history-entry';

            const queryElement = document.createElement('div');
            queryElement.className = 'history-query';
            queryElement.textContent = entry.query;

            const resultElement = document.createElement('div');
            resultElement.className = 'history-result';
            resultElement.textContent = `= ${entry.result}`;

            listItem.appendChild(queryElement);
            listItem.appendChild(resultElement);
            historyList.appendChild(listItem);
          }
        };

        const toggleHistory = () => {
          const collapsed = shell.dataset.history === 'collapsed';
          const nextState = collapsed ? 'open' : 'collapsed';
          shell.dataset.history = nextState;
          const expanded = nextState === 'open';
          if (historyPanel) {
            historyPanel.setAttribute('aria-hidden', expanded ? 'false' : 'true');
          }
          updateHistoryToggleState(expanded);
        };

        historyToggleButtons.forEach((button) => {
          button.addEventListener('click', toggleHistory);
        });

        updateHistoryToggleState(true);
        renderHistory();

        const setResult = (message, state) => {
          resultBox.dataset.state = state;
          resultText.textContent = message;
          resultBox.classList.remove('pulse');
          void resultBox.offsetWidth;
          resultBox.classList.add('pulse');
        };

        const sanitizeExpression = (expression) => {
          if (!expression || !/^[0-9+\-*/().\sA-Za-z_]+$/.test(expression)) {
            return false;
          }

          const identifierPattern = /[A-Za-z_][A-Za-z0-9_]*/g;
          let match;
          while ((match = identifierPattern.exec(expression)) !== null) {
            if (!allowedIdentifiers.has(match[0])) {
              return false;
            }
          }

          return true;
        };

        const consumeNumber = (tokens, startIndex) => {
          const current = tokens[startIndex];

          if (/^\d+$/.test(current)) {
            const numeric = Number.parseInt(current, 10);
            if (!Number.isFinite(numeric) || numeric < 0 || numeric > 1000000) {
              return null;
            }
            return { value: numeric, consumed: 1 };
          }

          if (Object.prototype.hasOwnProperty.call(onesMap, current)) {
            return { value: onesMap[current], consumed: 1 };
          }

          if (Object.prototype.hasOwnProperty.call(tensMap, current)) {
            let value = tensMap[current];
            let consumed = 1;
            const next = tokens[startIndex + 1];
            if (next && Object.prototype.hasOwnProperty.call(onesMap, next)) {
              const onesValue = onesMap[next];
              if (onesValue >= 10) {
                return null;
              }
              value += onesValue;
              consumed = 2;
            }
            if (value > 99) {
              return null;
            }
            return { value, consumed };
          }

          return null;
        };

        const parseQuery = (raw) => {
          if (!raw) {
            return { error: 'No input provided', steps: [] };
          }

          let prepared = raw
            .toLowerCase()
            .replace(/-/g, ' ')
            .replace(/\b(open|left|opening)\s+(?:parenthesis|parentheses|paren|bracket|brackets)\b/g, 'open_paren')
            .replace(/\b(close|right|closing)\s+(?:parenthesis|parentheses|paren|bracket|brackets)\b/g, 'close_paren')
            .replace(/multiplied\s+by/g, 'multiplied_by')
            .replace(/divided\s+by/g, 'divided_by')
            .replace(/open\s+brackets?/g, 'open_paren')
            .replace(/close\s+brackets?/g, 'close_paren')
            .replace(/open\s+parentheses/g, 'open_paren')
            .replace(/close\s+parentheses/g, 'close_paren')
            .replace(/open\s+paren/g, 'open_paren')
            .replace(/close\s+paren/g, 'close_paren')
            .replace(/\(/g, ' open_paren ')
            .replace(/\)/g, ' close_paren ')
            .replace(/[^a-z0-9_\s]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

          if (!prepared) {
            return { error: 'Could not understand the request', steps: [] };
          }

          const steps = [];
          steps.push(`Normalize input → "${prepared.replace(/_/g, ' ')}"`);

          const tokens = prepared.split(' ').filter(Boolean);
          if (!tokens.length) {
            return { error: 'Could not parse query', steps };
          }

          steps.push(`Tokenize → [${tokens.map(formatTokenDisplay).join(', ')}]`);

          const filteredTokens = tokens.filter((token) => !skipTokens.has(token));

          if (!filteredTokens.length) {
            steps.push('Filter filler words → []');
            return { error: 'Need a number, constant, or function to evaluate', steps };
          }

          if (filteredTokens.length !== tokens.length) {
            steps.push(`Filter filler words → [${filteredTokens.map(formatTokenDisplay).join(', ')}]`);
          }

          const normalizedTokens = filteredTokens.map((token) => {
            if (token === 'open_paren') return '(';
            if (token === 'close_paren') return ')';
            return token;
          });

          if (
            normalizedTokens.length !== filteredTokens.length ||
            normalizedTokens.some((token, index) => token !== filteredTokens[index])
          ) {
            steps.push(`Replace bracket phrases → [${normalizedTokens.map(formatTokenDisplay).join(', ')}]`);
          }

          let position = 0;

          const parseValue = () => {
            if (position >= normalizedTokens.length) {
              throw new Error('Expected a value but reached the end of the query');
            }

            const current = normalizedTokens[position];

            if (current === ')') {
              throw new Error('Unexpected closing bracket');
            }

            if (current === '(') {
              position += 1;
              const inner = parseExpression();
              if (position >= normalizedTokens.length || normalizedTokens[position] !== ')') {
                throw new Error('Missing closing bracket for "("');
              }
              position += 1;
              return `(${inner})`;
            }

            if (Object.prototype.hasOwnProperty.call(functionNameMap, current)) {
              const functionName = functionNameMap[current];
              position += 1;
              if (position >= normalizedTokens.length) {
                throw new Error(`Function "${current}" needs a value or bracketed expression`);
              }
              const argument = parseValue();
              if (argument.startsWith('(') && argument.endsWith(')')) {
                return `${functionName}${argument}`;
              }
              return `${functionName}(${argument})`;
            }

            if (Object.prototype.hasOwnProperty.call(constantsMap, current)) {
              position += 1;
              return constantsMap[current];
            }

            const numberResult = consumeNumber(normalizedTokens, position);
            if (numberResult) {
              position += numberResult.consumed;
              return String(numberResult.value);
            }

            if (/^\d+(?:\.\d+)?$/.test(current)) {
              position += 1;
              return current;
            }

            throw new Error(`Unrecognized token "${current}"`);
          };

          const parseExpression = () => {
            const firstValue = parseValue();
            const segments = [firstValue];

            while (position < normalizedTokens.length) {
              const nextToken = normalizedTokens[position];
              if (nextToken === ')') {
                break;
              }

              if (!Object.prototype.hasOwnProperty.call(operatorMap, nextToken)) {
                throw new Error(`Expected an operator but found "${nextToken}"`);
              }

              const operatorSymbol = operatorMap[nextToken];
              position += 1;
              const nextValue = parseValue();
              segments.push(operatorSymbol, nextValue);
            }

            return segments.join(' ');
          };

          let expression;
          try {
            expression = parseExpression();
          } catch (error) {
            return { error: error.message || 'Could not parse query', steps };
          }

          if (!expression) {
            return { error: 'Could not parse query', steps };
          }

          if (position < normalizedTokens.length) {
            const remaining = normalizedTokens[position];
            if (remaining === ')') {
              return { error: 'Missing opening bracket for ")"', steps };
            }
            return { error: `Unexpected token "${remaining}"`, steps };
          }

          if (!sanitizeExpression(expression)) {
            return { error: 'Expression contains unsupported content', steps };
          }

          steps.push(`Interpret tokens → ${expression}`);

          return { expression, steps };
        };

        const formatResult = (value) => {
          const numeric = Number(value);
          if (Number.isFinite(numeric)) {
            if (Number.isInteger(numeric)) {
              return numeric.toString();
            }
            const trimmed = Number.parseFloat(numeric.toFixed(6));
            return trimmed.toString();
          }
          return value;
        };

        const handleCalculation = async () => {
          const query = input.value.trim();
          if (!query) {
            clearSteps();
            setResult('Enter a math question using words to evaluate it.', 'info');
            input.focus();
            return;
          }

          const parsed = parseQuery(query);
          if (!parsed || parsed.error) {
            if (parsed && parsed.steps) {
              renderSteps(parsed.steps);
            } else {
              clearSteps();
            }
            setResult(parsed?.error || 'Could not parse query', 'error');
            return;
          }

          if (!runtimeReady) {
            clearSteps();
            setResult('Runtime still loading. Please wait a moment…', 'loading');
            return;
          }

          const { expression, steps: parseSteps } = parsed;

          clearSteps();
          setResult('Calculating…', 'loading');
          button.disabled = true;

          try {
            const pyodide = await pyodideReady;
            const python = `from math import *\nresult = eval(${JSON.stringify(expression)})\nstr(result)`;
            let outcome;
            try {
              outcome = pyodide.runPython(python);
            } catch (error) {
              clearSteps();
              setResult('Invalid math expression', 'error');
              console.error('[LangMath] Evaluation error', error);
              return;
            }

            const message = formatResult(outcome);
            setResult(message, 'result');
            const finalSteps = [...parseSteps, `Evaluate expression → ${expression} = ${message}`];
            renderSteps(finalSteps);
            historyEntries.push({ query, result: message });
            renderHistory();
          } finally {
            button.disabled = false;
          }
        };

        button.disabled = true;
        setResult('Loading Python runtime…', 'loading');

        pyodideReady
          .then((pyodide) => {
            runtimeReady = true;
            button.disabled = false;
            setResult('Ready when you are! Try “six times seven”.', 'info');
            if (!input.value) {
              input.focus();
            }

            const smokeTests = [
              { input: 'two plus two', expected: '4' },
              { input: 'thirteen minus eight', expected: '5' },
              { input: 'six times seven', expected: '42' },
              { input: 'forty divided by five', expected: '8' },
              { input: 'factorial of five', expected: '120' },
              { input: 'Tau divided by two', expected: '3.141593' },
              { input: 'pi plus one', expected: '4.141593' },
              { input: 'sqrt 100', expected: '10' },
              { input: 'exp 1', expected: '2.718282' },
              { input: 'log10 1000', expected: '3' },
              { input: 'log2 32', expected: '5' },
              { input: 'ln 1', expected: '0' },
              { input: 'sin 0', expected: '0' },
              { input: 'cos 0', expected: '1' },
              { input: 'tan 0', expected: '0' },
              { input: 'open bracket three plus five close bracket times two', expected: '16' },
            ];

            smokeTests.forEach((test) => {
              const parsedTest = parseQuery(test.input);
              if (!parsedTest) {
                console.warn('[LangMath] Failed to parse sample input:', test.input);
                return;
              }
              const { expression } = parsedTest;

              try {
                const python = `from math import *\nresult = eval(${JSON.stringify(expression)})\nstr(result)`;
                const output = pyodide.runPython(python);
                const formatted = formatResult(output);
                const pass = formatted === test.expected;
                console[pass ? 'info' : 'warn'](
                  `[LangMath] Sample ${pass ? 'pass' : 'mismatch'} — "${test.input}" = ${formatted} (expected ${test.expected})`
                );
              } catch (error) {
                console.error('[LangMath] Sample evaluation failed:', test.input, error);
              }
            });
          })
          .catch((error) => {
            console.error('[LangMath] Failed to load Pyodide', error);
            setResult('Could not start Python runtime', 'error');
          });

        button.addEventListener('click', handleCalculation);
        input.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleCalculation();
          }
        });
      })();
    </script>
  </body>
</html>
